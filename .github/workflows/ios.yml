name: iOS CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Resolve simulator destination
        run: |
          DEST=$(python3 -c "
          import json, subprocess, sys
          result = subprocess.run(['xcrun', 'simctl', 'list', 'devices', 'available', '-j'], capture_output=True, text=True)
          data = json.loads(result.stdout)
          best = None
          for runtime, devices in data['devices'].items():
              if 'com.apple.CoreSimulator.SimRuntime.iOS' not in runtime:
                  continue
              for d in devices:
                  if d.get('isAvailable') and 'iPhone' in d['name']:
                      if best is None or runtime > best[0]:
                          best = (runtime, d['name'])
          if best:
              print('platform=iOS Simulator,OS=latest,name=' + best[1])
          else:
              print('platform=iOS Simulator,OS=latest,name=iPhone 16')
          ")
          echo "DESTINATION=$DEST" >> "$GITHUB_ENV"
          echo "Selected destination: $DEST"

      - name: Build
        run: |
          set -o pipefail
          xcodebuild build \
            -project CathedralOSApp.xcodeproj \
            -scheme CathedralOSApp \
            -sdk iphonesimulator \
            -destination "$DESTINATION" \
            CODE_SIGNING_ALLOWED=NO

      - name: Run unit tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project CathedralOSApp.xcodeproj \
            -scheme CathedralOSApp \
            -sdk iphonesimulator \
            -destination "$DESTINATION" \
            CODE_SIGNING_ALLOWED=NO
